# 权限系统说明文档

> **⚠️ 重要更新**: 通配符权限功能已被移除，现在使用更细粒度的权限控制。如需全部权限，请使用 `super` 权限。


## 概述

本系统采用基于角色的访问控制（RBAC）模型，支持通配符权限匹配，提供灵活且安全的权限管理机制。

## 权限格式规范

### 基本格式

权限采用 `模块:操作` 的格式，例如：

- `user:read` - 用户读取权限
- `role:create` - 角色创建权限
- `script:delete` - 剧本删除权限

### 通配符权限格式

#### 1. 超级权限

- `*` 或 `*:*` - 拥有所有权限

#### 2. 模块通配符权限

- `user:*` - 拥有用户模块的所有权限
- `role:*` - 拥有角色模块的所有权限
- `script:*` - 拥有剧本模块的所有权限

#### 3. 操作通配符权限

- `*:read` - 拥有所有模块的读取权限
- `*:create` - 拥有所有模块的创建权限
- `*:delete` - 拥有所有模块的删除权限

#### 4. 具体权限

- `user:read` - 用户读取权限
- `role:update` - 角色更新权限

## 权限匹配优先级

权限检查按以下优先级进行匹配：

1. **超级权限** (`*` 或 `*:*`) - 最高优先级
2. **精确匹配** (`module:action`) - 精确匹配具体权限
3. **模块通配符** (`module:*`) - 匹配模块的所有操作
4. **操作通配符** (`*:action`) - 匹配所有模块的特定操作

## 系统内置权限列表

### 用户管理权限 (user)

| 权限名称 | 中文说明 | 用途描述 |
|---------|---------|----------|
| `user:read` | 用户查看权限 | 查看用户列表、用户详情、用户档案等 |
| `user:create` | 用户创建权限 | 创建新用户账户 |
| `user:update` | 用户更新权限 | 修改用户信息、更新用户状态 |
| `user:delete` | 用户删除权限 | 删除用户账户 |
| `user:manage` | 用户管理权限 | 用户的完整管理权限，包括批量操作 |
| `user:*` | 用户模块全部权限 | 用户模块的所有操作权限 |

### 角色权限管理 (role)

| 权限名称 | 中文说明 | 用途描述 |
|---------|---------|----------|
| `role:read` | 角色查看权限 | 查看角色列表、角色详情、角色权限 |
| `role:create` | 角色创建权限 | 创建新角色 |
| `role:update` | 角色更新权限 | 修改角色信息、更新角色权限 |
| `role:delete` | 角色删除权限 | 删除角色 |
| `role:assign` | 角色分配权限 | 为用户分配或移除角色 |
| `role:*` | 角色模块全部权限 | 角色模块的所有操作权限 |

### 权限管理 (permission)

| 权限名称 | 中文说明 | 用途描述 |
|---------|---------|----------|
| `permission:read` | 权限查看权限 | 查看权限列表、权限详情、用户权限 |
| `permission:create` | 权限创建权限 | 创建自定义权限 |
| `permission:update` | 权限更新权限 | 修改权限信息 |
| `permission:delete` | 权限删除权限 | 删除自定义权限 |
| `permission:*` | 权限模块全部权限 | 权限模块的所有操作权限 |

### 剧本管理权限 (script)

| 权限名称 | 中文说明 | 用途描述 |
|---------|---------|----------|
| `script:read` | 剧本查看权限 | 查看剧本列表、剧本详情、剧本内容 |
| `script:create` | 剧本创建权限 | 创建新剧本 |
| `script:update` | 剧本更新权限 | 修改剧本信息、更新剧本内容 |
| `script:delete` | 剧本删除权限 | 删除剧本 |
| `script:manage` | 剧本管理权限 | 剧本的完整管理权限 |
| `script:*` | 剧本模块全部权限 | 剧本模块的所有操作权限 |

### 音频管理权限 (audio)

| 权限名称 | 中文说明 | 用途描述 |
|---------|---------|----------|
| `audio:read` | 音频查看权限 | 查看音频列表、音频详情、播放音频 |
| `audio:create` | 音频创建权限 | 上传新音频文件 |
| `audio:update` | 音频更新权限 | 修改音频信息、更新音频文件 |
| `audio:delete` | 音频删除权限 | 删除音频文件 |
| `audio:manage` | 音频管理权限 | 音频的完整管理权限 |
| `audio:*` | 音频模块全部权限 | 音频模块的所有操作权限 |

### 审听管理权限 (review)

| 权限名称 | 中文说明 | 用途描述 |
|---------|---------|----------|
| `review:read` | 审听查看权限 | 查看审听记录、审听详情 |
| `review:create` | 审听创建权限 | 创建审听任务、提交审听结果 |
| `review:update` | 审听更新权限 | 修改审听信息、更新审听状态 |
| `review:delete` | 审听删除权限 | 删除审听记录 |
| `review:manage` | 审听管理权限 | 审听的完整管理权限 |
| `review:*` | 审听模块全部权限 | 审听模块的所有操作权限 |

### 系统管理权限 (system)

| 权限名称 | 中文说明 | 用途描述 |
|---------|---------|----------|
| `system:read` | 系统查看权限 | 查看系统信息、系统日志、统计数据 |
| `system:config` | 系统配置权限 | 修改系统配置、系统设置 |
| `system:init` | 系统初始化权限 | 初始化系统数据、重置系统状态 |
| `system:backup` | 系统备份权限 | 创建系统备份、恢复系统数据 |
| `system:*` | 系统模块全部权限 | 系统模块的所有操作权限 |

### 超级权限

| 权限名称 | 中文说明 | 用途描述 |
|---------|---------|----------|
| `*` 或 `*:*` | 超级管理员权限 | 拥有系统的所有权限，最高级别权限 |

## 系统预设角色

### 1. 超级管理员 (super_admin)

- **权限**: `*` (所有权限)
- **描述**: 系统最高权限角色，拥有所有功能的完整访问权限
- **适用人员**: 系统管理员、技术负责人

### 2. 系统管理员 (system_admin)

- **权限**: `user:*`, `role:*`, `permission:*`, `system:*`
- **描述**: 负责用户、角色、权限和系统管理
- **适用人员**: 系统运维人员、管理员

### 3. 项目组长 (project_leader)

- **权限**: `user:read`, `script:*`, `audio:*`, `review:*`
- **描述**: 负责项目管理，包括剧本、音频和审听的完整管理
- **适用人员**: 项目负责人、团队领导

### 4. 剧本编辑 (script_editor)

- **权限**: `script:read`, `script:create`, `script:update`
- **描述**: 负责剧本的创建和编辑工作
- **适用人员**: 剧本编辑人员、内容创作者

### 5. 音频制作 (audio_producer)

- **权限**: `audio:read`, `audio:create`, `audio:update`, `script:read`
- **描述**: 负责音频制作和处理工作
- **适用人员**: 音频制作人员、录音师

### 6. 审听员 (reviewer)

- **权限**: `review:read`, `review:create`, `review:update`, `audio:read`, `script:read`
- **描述**: 负责音频审听和质量检查工作
- **适用人员**: 审听人员、质检员

### 7. 观察员 (observer)

- **权限**: `user:read`, `script:read`, `audio:read`, `review:read`
- **描述**: 只读权限，可以查看各模块信息但不能修改
- **适用人员**: 观察员、临时访问人员

### 8. 普通用户 (user)

- **权限**: `script:read`, `audio:read`
- **描述**: 基础用户权限，可以查看剧本和音频
- **适用人员**: 一般用户、访客

## API 接口说明

### 权限相关接口

#### 1. 获取用户权限

- **接口**: `GET /api/v1/users/me/permissions`
- **说明**: 获取当前用户的所有权限（包括通配符权限）
- **返回**: 权限字符串数组

#### 2. 获取用户展开权限

- **接口**: `GET /api/v1/users/me/permissions/expanded`
- **说明**: 获取当前用户的展开权限列表（将通配符权限展开为具体权限）
- **返回**: 具体权限字符串数组

#### 3. 获取指定用户权限

- **接口**: `GET /api/v1/users/permissions/{user_id}`
- **说明**: 获取指定用户的所有权限（包括通配符权限）
- **权限要求**: `user:read`
- **返回**: 权限字符串数组

#### 4. 获取指定用户展开权限

- **接口**: `GET /api/v1/roles/user/permissions/{user_id}/expanded`
- **说明**: 获取指定用户的展开权限列表
- **权限要求**: `permission:read`
- **返回**: 具体权限字符串数组

#### 5. 检查用户权限

- **接口**: `POST /api/v1/roles/permission/check`
- **说明**: 检查用户是否拥有指定权限（支持通配符匹配）
- **权限要求**: `permission:read`
- **参数**: `user_id`, `permission`
- **返回**: `{"has_permission": boolean}`

### 角色管理接口

#### 1. 获取用户角色

- **接口**: `GET /api/v1/roles/user/{user_id}`
- **说明**: 获取指定用户的所有角色
- **权限要求**: `role:read`

#### 2. 分配角色

- **接口**: `POST /api/v1/roles/user/assign`
- **说明**: 为用户分配角色
- **权限要求**: `role:assign`

#### 3. 移除角色

- **接口**: `POST /api/v1/roles/user/unassign`
- **说明**: 移除用户的角色
- **权限要求**: `role:assign`

## 使用示例

### 1. 权限检查示例

```python
# 检查用户是否有具体权限
has_permission = await user.has_permission("user:read")

# 检查用户是否有模块通配符权限
has_permission = await user.has_permission("user:create")  # 如果用户有 user:* 权限，返回 True

# 检查用户是否有超级权限
has_permission = await user.has_permission("any:permission")  # 如果用户有 * 权限，返回 True
```

### 2. 角色权限配置示例

```python
# 创建具有通配符权限的角色
role_data = {
    "name": "content_manager",
    "display_name": "内容管理员",
    "permissions": ["script:*", "audio:read", "review:read"]
}

# 创建具有超级权限的角色
super_admin_data = {
    "name": "super_admin",
    "display_name": "超级管理员",
    "permissions": ["*"]
}
```

### 3. 权限展开示例

假设用户拥有权限：`["user:*", "script:read", "*:delete"]`

展开后的权限列表将包含：

- 所有 `user:` 开头的系统权限（如 `user:read`, `user:create`, `user:update`, `user:delete`, `user:manage`）
- `script:read`
- 所有以 `:delete` 结尾的系统权限（如 `user:delete`, `role:delete`, `script:delete` 等）

## 最佳实践

### 1. 权限设计原则

- **最小权限原则**: 用户只应拥有完成其工作所需的最小权限集
- **职责分离**: 不同角色应有明确的职责边界
- **权限继承**: 使用通配符权限简化权限管理

### 2. 角色设计建议

- **功能导向**: 根据用户的实际工作职能设计角色
- **层次化管理**: 建立清晰的权限层次结构
- **灵活配置**: 支持根据业务需求调整权限配置

### 3. 安全注意事项

- **定期审查**: 定期检查和清理不必要的权限
- **权限监控**: 监控敏感操作的权限使用情况
- **访问日志**: 记录重要权限操作的访问日志

## 系统初始化

### 初始化接口

- **接口**: `POST /api/v1/roles/system/init`
- **说明**: 初始化系统默认角色和权限
- **权限要求**: `system:init`
- **功能**:
  - 创建所有系统预设权限
  - 创建所有系统预设角色
  - 为角色分配相应权限

### 初始化内容

1. **权限初始化**: 创建所有内置权限定义
2. **角色初始化**: 创建8个预设角色
3. **权限分配**: 为每个角色分配相应的权限
4. **数据完整性**: 确保初始化过程的事务性和一致性

---

**注意**: 本文档描述的是权限系统的完整功能。在实际使用中，请根据具体的业务需求和安全要求进行适当的权限配置和管理。
