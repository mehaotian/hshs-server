# 业务状态码设计文档

## 概述

本文档定义了有声剧本管理系统的业务状态码规范，用于统一API响应格式和错误处理机制。

## 响应格式规范

### 统一响应格式

```json
{
  "code": 0,
  "message": "操作成功",
  "data": {}
}
```

### 字段说明

- `code`: 业务状态码，0表示成功，非0表示失败
- `message`: 响应消息，成功时为操作描述，失败时为错误描述
- `data`: 响应数据，成功时包含具体数据，失败时为空对象或null

## 业务状态码定义

### 成功状态码

| 状态码 | 含义 | 说明 |
|--------|------|------|
| 0 | 操作成功 | 所有成功操作的统一状态码 |

### 通用错误状态码 (1000-1999)

| 状态码 | 含义 | 说明 |
|--------|------|------|
| 1000 | 系统内部错误 | 服务器内部错误 |
| 1001 | 参数错误 | 请求参数格式或类型错误 |
| 1002 | 参数缺失 | 必需参数未提供 |
| 1003 | 参数值无效 | 参数值不符合要求 |
| 1004 | 请求方法不支持 | HTTP方法不被支持 |
| 1005 | 请求路径不存在 | API路径不存在 |
| 1006 | 请求频率过高 | 触发限流机制 |
| 1007 | 服务暂不可用 | 服务维护或临时不可用 |

### 认证授权错误 (2000-2999)

| 状态码 | 含义 | 说明 |
|--------|------|------|
| 2001 | 未登录 | 用户未登录或token无效 |
| 2002 | 登录已过期 | token已过期 |
| 2003 | 权限不足 | 用户权限不足以执行操作 |
| 2004 | 账号被禁用 | 用户账号已被禁用 |
| 2005 | 登录失败 | 用户名或密码错误 |

### 用户相关错误 (3000-3999)

| 状态码 | 含义 | 说明 |
|--------|------|------|
| 3001 | 用户名格式错误 | 用户名不符合格式要求 |
| 3002 | 用户名长度错误 | 用户名长度不符合要求 |
| 3003 | 用户名已存在 | 用户名已被注册 |
| 3004 | 邮箱格式错误 | 邮箱地址格式不正确 |
| 3005 | 邮箱已存在 | 邮箱已被注册 |
| 3006 | 密码长度错误 | 密码长度不符合要求 |
| 3007 | 密码格式错误 | 密码不符合复杂度要求 |
| 3008 | 密码不匹配 | 密码和确认密码不一致 |
| 3009 | 用户不存在 | 指定用户不存在 |
| 3010 | 原密码错误 | 修改密码时原密码不正确 |

### 角色权限错误 (4000-4999)

| 状态码 | 含义 | 说明 |
|--------|------|------|
| 4001 | 角色名称已存在 | 角色名称重复 |
| 4002 | 角色不存在 | 指定角色不存在 |
| 4003 | 角色正在使用 | 角色被用户使用，无法删除 |
| 4004 | 权限不存在 | 指定权限不存在 |
| 4005 | 权限已分配 | 权限已分配给角色 |

### 剧本相关错误 (5000-5999)

| 状态码 | 含义 | 说明 |
|--------|------|------|
| 5001 | 剧本标题已存在 | 剧本标题重复 |
| 5002 | 剧本不存在 | 指定剧本不存在 |
| 5003 | 剧本内容格式错误 | 剧本内容不符合格式要求 |
| 5004 | 剧本状态错误 | 剧本状态不允许当前操作 |
| 5005 | 剧本权限不足 | 用户无权限操作该剧本 |

### 音频相关错误 (6000-6999)

| 状态码 | 含义 | 说明 |
|--------|------|------|
| 6001 | 音频文件格式不支持 | 音频文件格式不被支持 |
| 6002 | 音频文件过大 | 音频文件超过大小限制 |
| 6003 | 音频上传失败 | 音频文件上传失败 |
| 6004 | 音频不存在 | 指定音频不存在 |
| 6005 | 音频处理失败 | 音频处理过程中出错 |
| 6006 | 音频转录失败 | AI转录服务失败 |

### 文件相关错误 (7000-7999)

| 状态码 | 含义 | 说明 |
|--------|------|------|
| 7001 | 文件格式不支持 | 文件格式不被支持 |
| 7002 | 文件过大 | 文件超过大小限制 |
| 7003 | 文件上传失败 | 文件上传失败 |
| 7004 | 文件不存在 | 指定文件不存在 |
| 7005 | 文件读取失败 | 文件读取过程中出错 |

## 验证错误处理规则

### 字段验证优先级

当存在多个字段验证错误时，按照以下优先级返回第一个错误：

1. 按字段在请求体中的定义顺序
2. 必填字段验证优先于格式验证
3. 格式验证优先于业务逻辑验证

### 验证错误映射

| Pydantic错误类型 | 业务状态码 | 错误消息模板 |
|------------------|------------|-------------|
| missing | 1002 | "{field_name}为必填项" |
| string_too_short | 1003 | "{field_name}至少需要{min_length}个字符" |
| string_too_long | 1003 | "{field_name}最多允许{max_length}个字符" |
| value_error (email) | 3004 | "邮箱地址格式不正确" |
| value_error (username) | 3001 | "用户名只能包含字母、数字、下划线和连字符" |
| value_error (password) | 3008 | "密码和确认密码不匹配" |

## 使用示例

### 成功响应示例

```json
{
  "code": 0,
  "message": "用户注册成功",
  "data": {
    "user_id": 123,
    "username": "testuser",
    "email": "test@example.com"
  }
}
```

### 验证错误响应示例

```json
{
  "code": 1002,
  "message": "用户名为必填项",
  "data": {}
}
```

### 业务错误响应示例

```json
{
  "code": 3003,
  "message": "用户名已存在",
  "data": {}
}
```

## 实现注意事项

1. **HTTP状态码统一为200**：所有API响应的HTTP状态码都应为200，通过业务状态码区分成功和失败

2. **错误优先级**：验证错误按字段顺序返回第一个错误，不返回所有错误

3. **消息本地化**：所有错误消息都应使用中文，便于前端直接展示给用户

4. **状态码扩展**：新增业务场景时，应按照分类规则分配新的状态码

5. **向后兼容**：已定义的状态码不应修改含义，确保API的向后兼容性

## 更新记录

| 版本 | 日期 | 更新内容 | 更新人 |
|------|------|----------|--------|
| 1.0.0 | 2025-01-08 | 初始版本，定义基础业务状态码体系 | 系统 |