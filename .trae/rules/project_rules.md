# Memory Bank

你熟悉 python ,擅长编写高性能专业的代码。你是python 和项目管理设计的专家
项目使用 Python + FastAPI + PostgreSQL 的开发。

## Code Style and Structure

    - 简洁易懂,复杂的代码配上中文注释.
    - 严格类型匹配,不使用隐式转换.
    - 不使用变量和函数的声明提升, 严格的在清晰的范围内使用变量和函数.
    - 当生成某个平台专用代码时, 应使用条件编译进行平台约束,避免干扰其他平台.
    
## 后端开发规范 (Python + FastAPI + PostgreSQL)

* **API 设计**：
  * **RESTful 原则**：遵循 RESTful API 设计原则，使用资源导向的 URL (例如 `/users`, `/dramas/audios{id}`)。
  * **版本控制**：考虑 API 版本化（例如 `/v1/users`），以便未来平滑升级。
  * **HTTP 方法**：正确使用 HTTP 方法（GET 用于查询，POST 用于创建，PUT/PATCH 用于更新，DELETE 用于删除）。
  * **状态码**：返回准确的 HTTP 状态码（例如 200 OK, 201 Created, 204 No Content, 400 Bad Request, 401 Unauthorized, 403 Forbidden, 404 Not Found, 500 Internal Server Error）。
* **数据验证与序列化 (Pydantic)**：
  * **请求体验证**：使用 Pydantic 模型定义请求体的结构和数据类型，FastAPI 会自动进行验证。
  * **响应序列化**：使用 Pydantic 模型定义响应数据的结构，确保返回给前端的数据格式正确且安全。
  * **字段过滤**：在响应模型中控制返回的字段，避免泄露敏感信息。
* **数据库交互 (SQLAlchemy)**：
  * **ORM 使用**：优先使用 SQLAlchemy ORM 进行数据库操作，利用其会话管理和事务支持。
  * **异步支持**：结合 `asyncio` 和 `asyncpg` 或使用支持异步的 ORM (如 Tortoise ORM) 来处理 PostgreSQL 数据库操作，以充分利用 FastAPI 的异步特性。
  * **事务管理**：对于涉及多个数据库操作的业务逻辑，确保使用数据库事务来保证数据一致性。
  * **连接池**：配置数据库连接池，优化数据库连接的创建和管理。
* **身份验证与授权**：
  * **JWT 策略**：实现基于 JWT 的身份验证，包括令牌的生成、验证和刷新机制。
  * **依赖注入**：利用 FastAPI 的依赖注入系统，在路由函数中注入当前用户对象，并进行权限检查。
  * **角色权限**：定义清晰的角色和权限体系，确保只有授权用户才能访问特定资源或执行特定操作。
* **错误处理**：
  * **全局异常处理**：实现全局异常处理器，捕获未处理的异常并返回统一的错误响应格式。
  * **业务异常**：定义自定义业务异常，并在业务逻辑中抛出，由全局异常处理器统一处理。
  * **日志记录**：所有错误和异常都应详细记录到日志中，包含请求信息、堆栈跟踪等。
* **日志记录**：
  * **分级记录**：使用 Python 的 `logging` 模块，根据重要性设置不同的日志级别（DEBUG, INFO, WARNING, ERROR, CRITICAL）。
  * **结构化日志**：考虑使用结构化日志（例如 JSON 格式），便于日志分析和检索。
  * **日志轮转**：配置日志文件轮转，防止日志文件过大。
* **异步编程**：
  * **`async`/`await`**：在所有 I/O 密集型操作（数据库查询、外部 API 调用、文件读写）中使用 `async`/`await`，确保非阻塞执行。
  * **后台任务**：对于耗时操作（如文件处理、AI 识别），使用 FastAPI 的 `BackgroundTasks` 或 Celery 等任务队列进行异步处理，避免阻塞 API 响应。
* **文件管理**：
  * **安全上传**：对上传的文件进行类型、大小、内容检查，防止恶意文件上传。
  * **文件路径**：存储文件时，使用安全的、不可预测的文件名或路径，避免路径遍历攻击。
  * **CDN/对象存储**：在生产环境中，将文件存储在 CDN 或对象存储服务（如阿里云 OSS、腾讯云 COS）上，通过预签名 URL 进行安全访问。

## 4. 数据库规范 (PostgreSQL)

* **Schema 设计**：
  * **命名约定**：表名使用小写复数形式（例如 `users`, `dramas`），列名使用小写下划线分隔（例如 `created_at`, `user_id`）。
  * **数据类型**：选择最合适的数据类型以优化存储和性能（例如，使用 `TEXT` 存储长文本，`JSONB` 存储非结构化数据）。
  * **范式化**：遵循适当的数据库范式，减少数据冗余，提高数据完整性。
  * **索引**：为经常用于查询条件、排序和连接的列创建索引，特别是外键和唯一约束。
* **数据完整性**：
  * **主键与外键**：所有表都应有主键。使用外键约束维护表之间的关系，确保引用完整性。
  * **唯一约束**：为需要唯一性的列添加唯一约束（例如用户名、剧本名称）。
  * **非空约束**：为必须有值的列添加非空约束。
* **性能优化**：
  * **查询优化**：避免 N+1 查询问题。使用 `JOIN` 替代多次查询。优化 `WHERE` 子句和 `ORDER BY` 子句。
  * **`EXPLAIN ANALYZE`**：定期使用 `EXPLAIN ANALYZE` 命令分析复杂查询的执行计划，识别性能瓶颈并进行优化。
  * **分区与分片**：对于数据量非常大的表，考虑使用表分区或数据库分片技术来提高查询性能和管理效率。
* **迁移管理**：
  * **Alembic**：使用 Alembic 等数据库迁移工具管理数据库 Schema 的变更，确保开发、测试和生产环境的数据库结构一致性。
  * **版本控制**：数据库迁移脚本应纳入版本控制。
* **备份与恢复**：
  * **定期备份**：实施自动化、定期的数据库全量和增量备份策略。
  * **异地备份**：将备份数据存储在不同的地理位置，以防灾难。
  * **恢复演练**：定期进行数据库恢复演练，确保备份的有效性和恢复流程的可靠性。

## 5. AI 集成规范

* **第三方 API 使用**：
  * **密钥管理**：AI 服务 API 密钥必须安全存储，并通过环境变量或密钥管理服务加载。
  * **速率限制与重试**：实现对第三方 API 的速率限制和指数退避重试机制，以应对服务限流或临时故障。
  * **错误处理**：对 AI 服务的响应进行充分的错误检查，并提供有意义的错误信息。
* **异步处理**：
  * **任务队列**：将所有 AI 相关的耗时任务（如音频转录、文本分析）放入 Celery 等任务队列中异步执行，避免阻塞主 API 线程。
  * **回调/Webhook**：如果 AI 服务支持回调或 Webhook，利用这些机制在任务完成后通知后端，更新状态。
* **数据隐私与合规性**：
  * **脱敏处理**：在发送敏感数据到第三方 AI 服务前，进行必要的脱敏处理。
  * **数据保留**：了解并遵守 AI 服务的数据保留政策，确保符合隐私法规。
  * **用户同意**：对于涉及用户个人数据的 AI 处理，应获得用户的明确同意。
* **模型管理与优化**：
  * **准确率评估**：定期评估 AI 模型的准确率，并根据业务需求进行调整或优化。
  * **成本监控**：监控 AI 服务的调用成本，并根据使用情况进行优化。

## 6. 部署规范

* **容器化 (Docker)**：
  * **Dockerfile**：为前端和后端应用编写清晰、优化的 Dockerfile，实现应用的容器化。
  * **Docker Compose**：使用 Docker Compose 管理多服务应用（前端、后端、数据库）的开发和本地部署。
  * **镜像管理**：使用私有或公共容器注册表存储和管理 Docker 镜像。
* **环境变量**：
  * **统一管理**：所有环境相关的配置（数据库连接字符串、API 密钥、服务端口等）都应通过环境变量进行配置。
  * **`.env` 文件**：在开发环境中使用 `.env` 文件管理环境变量，但 `.env` 文件不应提交到版本控制。
* **CI/CD (持续集成/持续部署)**：
  * **自动化流水线**：使用 GitLab CI/CD、GitHub Actions 或 Jenkins 等工具构建自动化 CI/CD 流水线，包括代码检查、测试、构建、镜像推送和部署。
  * **自动化测试**：在 CI/CD 流水线中集成自动化测试，确保每次代码提交都经过充分测试。
  * **蓝绿部署/灰度发布**：在生产环境中，考虑采用蓝绿部署或灰度发布策略，实现零停机部署和风险控制。
* **监控与日志记录**：
  * **应用性能监控 (APM)**：集成 APM 工具（如 Prometheus + Grafana, Sentry, ELK Stack）监控应用性能指标、错误率和响应时间。
  * **集中式日志**：将所有应用日志、系统日志集中收集到日志管理系统（如 ELK Stack 或 Loki + Grafana），便于统一查询和分析。
  * **告警机制**：设置关键指标的告警规则，当系统出现异常时及时通知相关人员。
* **基础设施即代码 (IaC)**：
  * **Terraform/Ansible**：考虑使用 Terraform 或 Ansible 等 IaC 工具管理基础设施资源（例如云服务器、数据库实例、网络配置），实现基础设施的自动化部署和版本控制。
